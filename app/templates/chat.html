{% extends "base.html" %}

{% block title %}Chat - SWAPP{% endblock %}

{% block extra_css %}
<style>
    #chatMessages {
        height: 500px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 10px;
    }
    .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 10px;
        max-width: 70%;
    }
    .message-sent {
        background: var(--primary-color);
        color: white;
        margin-left: auto;
        text-align: right;
    }
    .message-received {
        background: white;
        border: 1px solid #ddd;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-comment"></i> Chat with {{ other_user.username }}
                    <span class="trust-score ms-2">
                        <i class="fas fa-star"></i> {{ other_user.trust_score }}
                    </span>
                </h5>
            </div>
            <div class="card-body">
                <div id="chatMessages">
                    {% for message in messages %}
                        <div class="message {% if message.sender_id == current_user.id %}message-sent{% else %}message-received{% endif %}">
                            <strong>{% if message.sender_id == current_user.id %}You{% else %}{{ other_user.username }}{% endif %}</strong>
                            <small class="d-block text-muted">{{ message.created_at.strftime('%b %d, %I:%M %p') }}</small>
                            <p class="mb-0 mt-1">{{ message.content }}</p>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="input-group mt-3">
                    <input type="text" id="messageInput" class="form-control" placeholder="Type your message...">
                    <button id="sendBtn" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const socket = io();
const receiverId = {{ other_user.id }};

socket.emit('join_user_room');

socket.on('receive_message', (data) => {
    if (data.sender_id == {{ current_user.id }} || data.sender_id == receiverId) {
        const chatDiv = document.getElementById('chatMessages');
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message ' + (data.sender_id == {{ current_user.id }} ? 'message-sent' : 'message-received');
        msgDiv.innerHTML = `
            <strong>${data.sender_id == {{ current_user.id }} ? 'You' : '{{ other_user.username }}'}</strong>
            <small class="d-block text-muted">${new Date(data.created_at).toLocaleString()}</small>
            <p class="mb-0 mt-1">${data.content}</p>
        `;
        chatDiv.appendChild(msgDiv);
        chatDiv.scrollTop = chatDiv.scrollHeight;
    }
});

document.getElementById('sendBtn').addEventListener('click', () => {
    const input = document.getElementById('messageInput');
    if (input.value.trim()) {
        socket.emit('send_message', {
            receiver_id: receiverId,
            content: input.value
        });
        input.value = '';
    }
});

document.getElementById('messageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('sendBtn').click();
    }
});

const chatDiv = document.getElementById('chatMessages');
chatDiv.scrollTop = chatDiv.scrollHeight;
</script>
{% endblock %}
