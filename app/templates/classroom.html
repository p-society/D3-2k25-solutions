{% extends "base.html" %}

{% block title %}Classroom - SWAPP{% endblock %}

{% block extra_css %}
<style>
    #localVideo, #remoteVideo {
        width: 100%;
        max-width: 640px;
        border-radius: 10px;
        background: #000;
    }
    #classroomChat {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        background: #f9f9f9;
    }
    .chat-message {
        margin-bottom: 10px;
        padding: 8px;
        border-radius: 5px;
        background: white;
    }
</style>
{% endblock %}

{% block content %}
<h2 class="mb-4">
    <i class="fas fa-chalkboard-teacher"></i> Learning Session: {{ session.skill_topic }}
</h2>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header">
                <h5><i class="fas fa-video"></i> Video Session</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 text-center mb-3">
                        <h6>You</h6>
                        <video id="localVideo" autoplay muted playsinline></video>
                    </div>
                    <div class="col-md-6 text-center mb-3">
                        <h6>{% if session.teacher_id == current_user.id %}{{ session.learner.username }}{% else %}{{ session.teacher.username }}{% endif %}</h6>
                        <video id="remoteVideo" autoplay playsinline></video>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button id="startBtn" class="btn btn-success">
                        <i class="fas fa-video"></i> Start Video
                    </button>
                    <button id="muteBtn" class="btn btn-warning" disabled>
                        <i class="fas fa-microphone"></i> Mute
                    </button>
                    <button id="stopBtn" class="btn btn-danger" disabled>
                        <i class="fas fa-stop"></i> Stop
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-comments"></i> Classroom Chat</h5>
            </div>
            <div class="card-body">
                <div id="classroomChat"></div>
                <div class="input-group mt-2">
                    <input type="text" id="chatInput" class="form-control" placeholder="Type a message...">
                    <button id="sendChatBtn" class="btn btn-primary">Send</button>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-body">
                <h6>Session Info</h6>
                <p class="small mb-1"><i class="fas fa-user"></i> Teacher: {{ session.teacher.username }}</p>
                <p class="small mb-1"><i class="fas fa-user-graduate"></i> Learner: {{ session.learner.username }}</p>
                <p class="small mb-1"><i class="fas fa-clock"></i> Duration: {{ session.duration_minutes }} min</p>
                <a href="{{ url_for('sessions') }}" class="btn btn-secondary btn-sm mt-2 w-100">Exit Classroom</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const socket = io();
const roomId = '{{ session.room_id }}';
let localStream = null;
let peerConnection = null;

socket.emit('join_classroom', { room_id: roomId });

document.getElementById('startBtn').addEventListener('click', async () => {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
        document.getElementById('startBtn').disabled = true;
        document.getElementById('muteBtn').disabled = false;
        document.getElementById('stopBtn').disabled = false;
    } catch (error) {
        alert('Could not access camera/microphone: ' + error.message);
    }
});

document.getElementById('muteBtn').addEventListener('click', () => {
    const audioTrack = localStream.getAudioTracks()[0];
    audioTrack.enabled = !audioTrack.enabled;
    document.getElementById('muteBtn').innerHTML = audioTrack.enabled 
        ? '<i class="fas fa-microphone"></i> Mute' 
        : '<i class="fas fa-microphone-slash"></i> Unmute';
});

document.getElementById('stopBtn').addEventListener('click', () => {
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        document.getElementById('localVideo').srcObject = null;
        document.getElementById('startBtn').disabled = false;
        document.getElementById('muteBtn').disabled = true;
        document.getElementById('stopBtn').disabled = true;
    }
    socket.emit('leave_classroom', { room_id: roomId });
});

socket.on('classroom_chat_message', (data) => {
    const chatDiv = document.getElementById('classroomChat');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'chat-message';
    msgDiv.innerHTML = `<strong>${data.username}</strong> <small class="text-muted">${data.timestamp}</small><br>${data.message}`;
    chatDiv.appendChild(msgDiv);
    chatDiv.scrollTop = chatDiv.scrollHeight;
});

document.getElementById('sendChatBtn').addEventListener('click', () => {
    const input = document.getElementById('chatInput');
    if (input.value.trim()) {
        socket.emit('classroom_chat', {
            room_id: roomId,
            message: input.value
        });
        input.value = '';
    }
});

document.getElementById('chatInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('sendChatBtn').click();
    }
});
</script>
{% endblock %}
